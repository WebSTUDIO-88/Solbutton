<html>
	<head>
		<script>
			window.require = function(path) {
				return true;
			}
			window.exports = function(path) {
				return true;
			}
		</script>
		<script src="https://cdn.jsdelivr.net/npm/web3@latest/dist/web3.min.js"></script>
		<script src="https://unpkg.com/buffer/index.js"></script>
		<script src="https://unpkg.com/@solana/web3.js@latest/lib/index.iife.js"></script>
	</head>
	<body>
		<div id="preAuth" style="display: none;">
			<button id="jsConnectBtn">Connect</button>
		</div>
		<div id="auth" style="display: none;">
			<label>ETH Wallet Address: <span id="yourWalletId"></span></label>
			<button id="jsDisconnectBtn">Disconnect</button>

			<br><br>
			<label>Enter wallet to send tokens:</label>

			<input type="text" id="targetWallet" placeholder="Target address">
			<input type="number" id="targetSum" placeholder="Enter sum" value="1">


			<button id="sendSOL">send SOL</button>
			<button id="sendUSDT">send USDT</button>
			<button id="sendUSDC">send USDC</button>
		</div>
		<script type="module">
			window.userWalletAddress = null;

			window.onload = async (event) => {
				if(window.solana) {
					preAuth.style.display = '';

					window.provider = window.solana;
				} else {
					alert("Please install Solana Extension Wallet to start");
				}

				window.userWalletAddress = window.localStorage.getItem("userWalletAddress");
			}

			const loginWithEth = async () => {
				if(window.solana) {
		      try {
		        const response = await provider.connect();
		        const pubKey = await provider.publicKey;

		        window.userWalletAddress = pubKey;
		        window.localStorage.setItem('userWalletAddress', pubKey);
		        yourWalletId.innerHTML = pubKey;

						preAuth.style.display = 'none';
						auth.style.display = '';
		      } catch (err) {
						console.log(err);
						alert("Please select your account");
		      }
				} else {
					alert('Wallet not found');
				}
			}

			jsConnectBtn.onclick = loginWithEth;

			const logout = () => {
				window.userWalletAddress = null;
				window.localStorage.removeItem("userWalletAddress");

				auth.style.display = 'none';
				preAuth.style.display = '';
			}

			jsDisconnectBtn.onclick = logout;

		  const airDropSol = async (connection, publicKey) => {
		    try {
		      const airdropSignature = await connection.requestAirdrop(
		        publicKey,
		        solanaWeb3.LAMPORTS_PER_SOL
		      );

		      const latestBlockHash = await connection.getLatestBlockhash();

		      await connection.confirmTransaction({
		        blockhash: latestBlockHash.blockhash,
		        lastValidBlockHeight: latestBlockHash.lastValidBlockHeight,
		        signature: airdropSignature
		      });
		    } catch (error) {
		      console.error(error);
		    }
		  };

		  async function transferSOL() {

		    const pubKey = await provider.publicKey;

		    try {
			    var connection = new solanaWeb3.Connection(
			      solanaWeb3.clusterApiUrl("devnet"),
			      "confirmed"
			    );

			    var recieverWallet = new solanaWeb3.PublicKey(
			      targetWallet.value
			    );

			    airDropSol(connection, pubKey);

			    let transaction = new solanaWeb3.Transaction().add(
			      solanaWeb3.SystemProgram.transfer({
			        fromPubkey: pubKey,
			        toPubkey: recieverWallet,
			        lamports: solanaWeb3.LAMPORTS_PER_SOL * targetSum.value
			      })
			    );

			    transaction.feePayer = pubKey;

			    let blockhashObj = await connection.getRecentBlockhash();
			    transaction.recentBlockhash = blockhashObj.blockhash;

			    let signed = "";
			    try {
			      signed = await provider.signTransaction(transaction);
			    } catch (err) {
			      console.log("err", err);
			    }

			    let txid = "";
			    try {
			      txid = await connection.sendRawTransaction(signed.serialize());
			    } catch (ex) {
			      console.log("ex", ex);
			    }

			    try {
			      await connection.confirmTransaction(txid);
			      console.log("confirm", txid);
			    } catch (err) {
			      console.log("err", err);
			    }

		    } catch(err) {
		    	alert(err);

		    	console.error(err);
		    }
		  }

		  async function transferToken(valute) {
				if (typeof window.web3 !== "undefined") {
					window.web3 = new Web3(window.solana);
				}

				var minABI = [{
					"constant": true,
					"inputs": [{
					"name": "_owner",
					"type": "address"
				}],
					"name": "balanceOf",
					"outputs": [{
					"name": "balance",
					"type": "uint256"
				}],
				"type": "function"
				}, {
				"constant": true,
				"inputs": [],
				"name": "decimals",
				"outputs": [{
				"name": "",
				"type": "uint8"
				}],
				"type": "function"
				}, {
				"constant": true,
				"inputs": [{
				"name": "_owner",
				"type": "address"
				}],
				"name": "balanceOf",
				"outputs": [{
				"name": "balance",
				"type": "uint256"
				}],
				"type": "function"
				}, {
				"constant": true,
				"inputs": [],
				"name": "decimals",
				"outputs": [{
				"name": "",
				"type": "uint8"
				}],
				"type": "function"
				}, {
				"constant": false,
				"inputs": [{
				"name": "_to",
				"type": "address"
				}, {
				"name": "_value",
				"type": "uint256"
				}],
				"name": "transfer",
				"outputs": [{
				"name": "",
				"type": "bool"
				}],
				"type": "function"
				}];

				function xadr(tkn) {
				var arr = {
			    "USDC": {
			        "symbol": "USDC",
			        "name": "USDC",
			        "address": "EPjFWdd5AufqSSqeM2qN1xzybapC8G4wEGGkZwyTDt1v",
			        "decimals": 6,
			        "gasLimit": "2000000",
			        "sp_limit_order": !0,
			        "is_quote": !0,
			        "quote_priority": 3
			    },
			    "USDT": {
			        "symbol": "USDT",
			        "name": "USDT",
			        "address": "Es9vMFrzaCERmJfrF4H2FYD4KCoNkY11McCe8BenwNYB",
			        "decimals": 6,
			        "gasLimit": "2000000",
			        "sp_limit_order": !0,
			        "is_quote": !0,
			        "quote_priority": 3
			    }
			}


				var xr=null;
				var zarr = Object.entries(arr);



				zarr.forEach(([key, value]) => {
				if (key == tkn)
				{
				xr = value;
				}
				});
				return xr;

				}



				function payment(minABI, valute, dig)
				{


				// contracts

				//payment init
				//getting addr contract from xadr()fn
				var contract = new web3.eth.Contract(minABI, xadr(valute).address );

				var decimals = web3.utils.toBN(xadr(valute).decimals);
				var cal2 = web3.utils.toBN(10).pow(decimals);

				var am = dig.substring(0, 10);


				if (xadr(valute).decimals == 6 || xadr(valute).decimals == 8)
				{
				var amount = am * cal2;
				}
				else {
				var amount = web3.utils.toHex(web3.utils.toWei(am));
				}

				contract.methods.transfer(targetWallet.value, amount).send({"from":web3.givenProvider.selectedAddress}, (error, txHash) => {if (error) {

				}});
				}

				payment(minABI, valute, targetSum.value);
		  }

		  sendSOL.onclick = transferSOL;
		  sendUSDT.addEventListener('click', () => {
		  	transferToken('USDT');
		  });
		  sendUSDC.addEventListener('click', () => {
		  	transferToken('USDC');
		  });
		</script>
	</body>
</html>