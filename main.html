<html>
	<head>
		<title>Solbutton v002 (mainnet beta)</title>
		<script type="text/javascript" src="bundle.js"></script>
	</head>
	<body>
		<div id="preAuth" style="display: none;">
			<button id="jsConnectBtn">Connect</button>
		</div>
		<form id="auth" style="display: none;">
			<label>ETH Wallet Address: <span id="yourWalletId"></span></label>
			<button id="jsDisconnectBtn">Disconnect</button>

			<br><br>
			<label>Enter wallet to send tokens:</label>

			<input type="text" id="targetWallet" name="to" placeholder="Target address" value="2xs16ihyv3Z6Kkcqt5j5wDarBHvtvoRqopjFnzfTJ7mK">
			<input type="number" id="targetSum" placeholder="Enter sum" value="1" name="amount">

			<input type="hidden" name="from" id="fromWalletField">


			<button id="sendSOL">send SOL</button>
			<button id="sendUSDT">send USDT</button>
			<button id="sendUSDC">send USDC</button>
		</form>
		<script>
			const web3 = require("@solana/web3.js");
			const splToken = require('@solana/spl-token');

			window.userWalletAddress = null;

			window.onload = async (event) => {
				if(window.solana) {
					preAuth.style.display = '';

					window.provider = window.solana;
				} else {
					alert("Please install Solana Extension Wallet to start");
				}

				window.userWalletAddress = window.localStorage.getItem("userWalletAddress");
			}

			const signSendAndConfirm = async (transaction, connection, signers = false) => {
		    let blockhashObj = await connection.getRecentBlockhash();
		    transaction.recentBlockhash = blockhashObj.blockhash;

		    let signed = "";
		    try {
		      signed = await provider.signTransaction(transaction);

		      if(signers) {
		      	signers.forEach(signer => {
		      			signed._partialSign(transaction.compileMessage(), signer);
		      	});
		      }
		    } catch (err) {
		      console.log("err", err);
		    }

		    let txid = "";
		    try {
		      txid = await connection.sendRawTransaction(signed.serialize());
		    } catch (ex) {
		      console.log("ex", ex);
		    }

		    try {
		      await connection.confirmTransaction(txid);
		      console.log("confirm", txid);
		    } catch (err) {
		      console.log("err", err);
		    }
			}

			const loginWithEth = async () => {
				if(window.solana) {
		      try {
		        const response = await provider.connect();
		        const pubKey = await provider.publicKey;

		        window.userWalletAddress = pubKey;
		        window.localStorage.setItem('userWalletAddress', pubKey);
		        yourWalletId.innerHTML = pubKey;
		        fromWalletField.value = pubKey;

				preAuth.style.display = 'none';
				auth.style.display = '';
		      } catch (err) {
				console.log(err);
				alert("Please select your account");
		      }
				} else {
					alert('Wallet not found');
				}
			}

			jsConnectBtn.onclick = loginWithEth;

			const logout = () => {
				window.userWalletAddress = null;
				window.localStorage.removeItem("userWalletAddress");

				auth.style.display = 'none';
				preAuth.style.display = '';
			}

			jsDisconnectBtn.onclick = logout;

		  async function transferSOL() {
		    const pubKey = await provider.publicKey;

		    try {
			    var connection = new web3.Connection(
			      web3.clusterApiUrl("mainnet-beta"),
			      "confirmed"
			    );

			    var recieverWallet = new web3.PublicKey(
			      targetWallet.value
			    );

			    let transaction = new web3.Transaction().add(
			      web3.SystemProgram.transfer({
			        fromPubkey: pubKey,
			        toPubkey: recieverWallet,
			        lamports: web3.LAMPORTS_PER_SOL * targetSum.value
			      })
			    );

			    transaction.feePayer = pubKey;

			    await signSendAndConfirm(transaction, connection);

		    } catch(err) {
		    	alert(err);

		    	console.error(err);
		    }
		  }

			async function sendToken (fromWalletAddress, toWalletAddress, amount, token) {
			  console.log('start operation');

			  const programId = splToken.TOKEN_PROGRAM_ID;
			  //const programId = new web3.PublicKey('TokenkegQfeZyiNwAJbNbGKPFXCWuBvf9Ss623VQ5DA');

		    const connection = new web3.Connection(web3.clusterApiUrl('devnet'), 'confirmed');

	      const fromWallet = window.solana;

	      const toWallet = {
	        'publicKey': new web3.PublicKey(toWalletAddress)
	      };

		    const tokenVariants = {
		      usdt: {
		      	address: 'Es9vMFrzaCERmJfrF4H2FYD4KCoNkY11McCe8BenwNYB',
		        mint: 'Q6XprfkF8RQQKoQVG33xT88H7wi8Uk1B1CC7YAs69Gi',
		        freeze: 'Q6XprfkF8RQQKoQVG33xT88H7wi8Uk1B1CC7YAs69Gi',
		      },
		      usdc: {
		      	address: 'EPjFWdd5AufqSSqeM2qN1xzybapC8G4wEGGkZwyTDt1v',
		        mint: '2wmVCSfPxGPjrnMMn7rchp4uaeoTqN39mXFC2zhPdri9',
		        freeze: '3sNBr7kMccME5D55xNgsmYpZnzPgP2g12CixAajXypn6'
		      }
		    }

		    const selectedToken = tokenVariants[token];

	      const mintPubkey = new web3.PublicKey(selectedToken.address);

	      console.log('account check');

				let signed = "";

	      fromTokenAccount = web3.Keypair.generate();

	      console.log([fromTokenAccount.publicKey, mintPubkey, fromWallet.publicKey, programId]);

	      window.tx = new web3.Transaction().add(
	      	web3.SystemProgram.createAccount({
	      		fromPubkey: fromWallet.publicKey,
	      		newAccountPubkey: fromTokenAccount.publicKey,
	      		space: splToken.ACCOUNT_SIZE,
	      		lamports: await splToken.getMinimumBalanceForRentExemptAccount(connection),
	      		programId: programId
	      	})
	      );

		    tx.feePayer = fromWallet.publicKey;

		    await signSendAndConfirm(tx, connection, [fromTokenAccount]);

		    let txid = "";
		    try {
		      console.log('init account');
		      console.log([fromWallet.publicKey, mintPubkey, fromWallet.publicKey, programId]);
		      tx = new web3.Transaction().add(
		      	splToken.createInitializeAccountInstruction(fromTokenAccount.publicKey, mintPubkey, fromWallet.publicKey, programId)
		      );

		    	tx.feePayer = fromWallet.publicKey;

		    	await signSendAndConfirm(tx, connection, [fromTokenAccount]);

		      console.log('account inited', tx);
		    } catch (ex) {
		      console.error(ex);

		      return -2;
		    }

	      console.log('receiver account getting');

		    let ata = await splToken.getAssociatedTokenAddress(
		      mintPubkey, // mint
		      toWallet.publicKey, // owner
		      false // allow owner off curve
		    );
		    console.log(`ata: ${ata.toBase58()}`);

		    tx = new web3.Transaction();
		    tx.add(
		      splToken.createAssociatedTokenAccountInstruction(
		        fromWallet.publicKey, // payer
		        ata, // ata
		        toWallet.publicKey, // owner
		        mintPubkey // mint
		      )
		    );

		    tx.feePayer = fromWallet.publicKey;

		    await signSendAndConfirm(tx, connection);

		    console.log(ata);

		    tx = new web3.Transaction();

		    tx.add(splToken.createTransferCheckedInstruction(
		    	fromTokenAccount.publicKey,
		    	mintPubkey,
		    	ata.publicKey,
		    	fromWallet.publicKey,
		    	amount * web3.LAMPORTS_PER_SOL,
		    	6
		    ));

		    await signSendAndConfirm(tx, connection);

		    /*let latestBlockHash = await (await connection.getLatestBlockhash('finalized'));

		    transaction.recentBlockhash = latestBlockHash.blockhash;
		    transaction.lastValidBlockHeight = latestBlockHash.lastValidBlockHeight;
		    
		    transaction.partialSign(fromWallet);

		    let response = await connection.confirmTransaction({
		      signature,
		      lastValidBlockHeight: latestBlockHash.lastValidBlockHeight,
		      blockhash: latestBlockHash.blockhash,
		    });*/

		    console.log('done');
			}

		  async function transferToken(valute) {
		  	sendToken(await provider.publicKey, targetWallet.value, targetSum.value, valute);
		  }

		  sendSOL.onclick = function(e) {
		  	e.preventDefault();
		  	transferSOL();
		  	return false;
		  };

		  sendUSDT.addEventListener('click', (e) => {
		  	e.preventDefault();

		  	transferToken('usdt');

		  	return false;
		  });
		  sendUSDC.addEventListener('click', (e) => {
		  	e.preventDefault();

		  	transferToken('usdc');

		  	return false;
		  });

		  auth.onsumit = (e) => { e.preventDefault(); return false;};
		</script>
	</body>
</html>