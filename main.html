<html>
	<head>
		<title>Solbutton v002 (mainnet beta)</title>
		<script type="text/javascript" src="bundle.js"></script>
	</head>
	<body>
		<div id="preAuth" style="display: none;">
			<button id="jsConnectBtn">Connect</button>
		</div>
		<form id="auth" style="display: none;">
			<label>ETH Wallet Address: <span id="yourWalletId"></span></label>
			<button id="jsDisconnectBtn">Disconnect</button>

			<br><br>
			<label>Enter wallet to send tokens:</label>

			<input type="text" id="targetWallet" name="to" placeholder="Target address">
			<input type="number" id="targetSum" placeholder="Enter sum" value="1" name="amount">

			<input type="hidden" name="from" id="fromWalletField">


			<button id="sendSOL">send SOL</button>
			<button id="sendUSDT">send USDT</button>
			<button id="sendUSDC">send USDC</button>
		</form>
		<script>
			const web3 = require("@solana/web3.js");
			const splToken = require('@solana/spl-token');

			window.userWalletAddress = null;

			window.onload = async (event) => {
				if(window.solana) {
					preAuth.style.display = '';

					window.provider = window.solana;
				} else {
					alert("Please install Solana Extension Wallet to start");
				}

				window.userWalletAddress = window.localStorage.getItem("userWalletAddress");
			}

			const loginWithEth = async () => {
				if(window.solana) {
		      try {
		        const response = await provider.connect();
		        const pubKey = await provider.publicKey;

		        window.userWalletAddress = pubKey;
		        window.localStorage.setItem('userWalletAddress', pubKey);
		        yourWalletId.innerHTML = pubKey;
		        fromWalletField.value = pubKey;

				preAuth.style.display = 'none';
				auth.style.display = '';
		      } catch (err) {
				console.log(err);
				alert("Please select your account");
		      }
				} else {
					alert('Wallet not found');
				}
			}

			jsConnectBtn.onclick = loginWithEth;

			const logout = () => {
				window.userWalletAddress = null;
				window.localStorage.removeItem("userWalletAddress");

				auth.style.display = 'none';
				preAuth.style.display = '';
			}

			jsDisconnectBtn.onclick = logout;

		  async function transferSOL() {
		    const pubKey = await provider.publicKey;

		    try {
			    var connection = new web3.Connection(
			      web3.clusterApiUrl("mainnet-beta"),
			      "confirmed"
			    );

			    var recieverWallet = new web3.PublicKey(
			      targetWallet.value
			    );

			    let transaction = new web3.Transaction().add(
			      web3.SystemProgram.transfer({
			        fromPubkey: pubKey,
			        toPubkey: recieverWallet,
			        lamports: web3.LAMPORTS_PER_SOL * targetSum.value
			      })
			    );

			    transaction.feePayer = pubKey;

			    let blockhashObj = await connection.getRecentBlockhash();
			    transaction.recentBlockhash = blockhashObj.blockhash;

			    let signed = "";
			    try {
			      signed = await provider.signTransaction(transaction);
			    } catch (err) {
			      console.log("err", err);
			    }

			    let txid = "";
			    try {
			      txid = await connection.sendRawTransaction(signed.serialize());
			    } catch (ex) {
			      console.log("ex", ex);
			    }

			    try {
			      await connection.confirmTransaction(txid);
			      console.log("confirm", txid);
			    } catch (err) {
			      console.log("err", err);
			    }

		    } catch(err) {
		    	alert(err);

		    	console.error(err);
		    }
		  }

			async function sendToken (fromWalletAddress, toWalletAddress, amount, token) {
			  console.log('start operation');

			  let isDevnet = true;
			    // Connect to cluster
			    const connection = new web3.Connection(web3.clusterApiUrl('mainnet-beta'), 'confirmed');

		      //const fromWallet = window.solana;
		      const fromWallet = web3.Keypair.generate();

		      const toWallet = {
		        'publicKey': new web3.PublicKey(toWalletAddress)
		      };

			    const tokenVariants = {
			      usdt: {
			        mint: 'Q6XprfkF8RQQKoQVG33xT88H7wi8Uk1B1CC7YAs69Gi',
			        freeze: 'Q6XprfkF8RQQKoQVG33xT88H7wi8Uk1B1CC7YAs69Gi',
			      },
			      usdc: {
			        mint: '2wmVCSfPxGPjrnMMn7rchp4uaeoTqN39mXFC2zhPdri9',
			        freeze: '3sNBr7kMccME5D55xNgsmYpZnzPgP2g12CixAajXypn6'
			      }
			    }

			    const selectedToken = tokenVariants[token];

		      console.log('mint init');

		      let mintData = new web3.PublicKey(selectedToken.mint);

		      console.log(mintData);

		      const mint = mintData;

		      console.log('account creating');

		      /*const fromTokenAccount = await splToken.getOrCreateAssociatedTokenAccount(
		          connection,
		          fromWallet,
		          mint,
		          fromWallet.publicKey
		      );*/

		      const fromTokenAccount = await splToken.createAssociatedTokenAccount(connection, fromWallet, mintData, fromWallet.publicKey, { commitment: 'confirmed' });

		      console.log('receiver account creating');

		      const toTokenAccount = await splToken.getOrCreateAssociatedTokenAccount(connection, toWallet.publicKey, mint, toWallet.publicKey);

			    let transaction = new web3.Transaction().add(
			      splToken.createTransferInstruction(
			          fromTokenAccount.address,
			          toTokenAccount.address,
			          fromWallet.publicKey,
			          targetSum.value * web3.LAMPORTS_PER_SOL
			      )
			    );


			    transaction.feePayer = fromWallet.publicKey
			    let latestBlockHash = await (await connection.getLatestBlockhash('finalized'));

			    transaction.recentBlockhash = latestBlockHash.blockhash;
			    transaction.lastValidBlockHeight = latestBlockHash.lastValidBlockHeight;
			    
			    transaction.partialSign(fromWallet);

			    const signed = await signTransaction(transaction);

			    const signature = await connection.sendRawTransaction(signed.serialize());

			    var response = await connection.confirmTransaction({
			      signature,
			      lastValidBlockHeight: latestBlockHash.lastValidBlockHeight,
			      blockhash: latestBlockHash.blockhash,
			    });
			}

		  async function transferToken(valute) {
		  	sendToken(await provider.publicKey, targetWallet.value, targetSum.value, valute);
		  }

		  sendSOL.onclick = function(e) {
		  	e.preventDefault();
		  	transferSOL();
		  	return false;
		  };

		  sendUSDT.addEventListener('click', (e) => {
		  	e.preventDefault();

		  	transferToken('usdt');

		  	return false;
		  });
		  sendUSDC.addEventListener('click', (e) => {
		  	e.preventDefault();

		  	transferToken('usdc');

		  	return false;
		  });

		  auth.onsumit = (e) => { e.preventDefault(); return false;};
		</script>
	</body>
</html>